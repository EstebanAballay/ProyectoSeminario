<div class="container-viajes">
  <h2 style="color:white">Viajes Pendientes de Confirmación</h2>

  <div class="card-viaje" *ngFor="let viaje of viajes">
    <!-- Aca muestro el origen y el destino -->
    <div class="card-header">
      <div class="info-principal">
        <span class="ruta">{{ viaje.destinoInicio.slice(0,viaje.destinoInicio.indexOf(','))}} ➝ {{ viaje.destinoFin.slice(0,viaje.destinoFin.indexOf(',')) }}</span>
        <div class=info-fechas>
          <div>
            <i class="fa-regular fa-calendar-check"></i>
            <strong>Inicio del viaje:</strong> {{ viaje.fechaInicio }} {{viaje.horaSalida}}</div>
          <div style="margin-top: 5px;"> <i class="fa-solid fa-rotate-left"></i>
            <strong>Retorno a las instalaciones:</strong> {{ viaje.fechaFin }} {{viaje.horaLlegada}}</div>
        </div>
      </div>
      <div class="estado-badge">{{ viaje.estadoViaje.nombre }}</div>
    </div>
      
    <button class="btn-toggle" (click)="toggleDetalle(viaje)">
      <i class="fa-solid" [ngClass]="viaje.expandido ? 'fa-chevron-up' : 'fa-chevron-down'"> </i>
    </button>

    <div class="card-detalle" *ngIf="viaje.expandido">
      
      <div class="datos-extra">
        <p><strong>Distancia:</strong> {{ viaje.distancia }}</p>
        <p><strong>Duración Estimada(solo ida):</strong> {{ viaje.duracion }}</p>
      </div>

      <div [id]="'map-' + viaje.ViajeId" class="mapa-container"></div>

      <hr>

      <div class="acciones" *ngIf="!viaje.seleccionandoChofer">
        <button class="btn-rechazar" (click)="rechazarViaje(viaje)">
          <i class="fa-solid fa-xmark"></i> Rechazar
        </button>
        <button class="btn-asignar" (click)="iniciarAsignacion(viaje)">
          <i class="fa-solid fa-user-plus"></i> Asignar Choferes
        </button>
      </div>

      <div *ngIf="viaje.seleccionandoChofer" class="area-asignacion" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
        <h4 style="color: #333; margin-bottom: 15px;">Asignación de Unidades</h4>

        <div class="tarjeta-asignacion" *ngFor="let unidad of viaje.unidades" style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px;">
          <div class="info-unidad" style="margin-bottom: 5px;">
            <i class="fa-solid fa-truck"></i> <strong>Unidad: </strong>{{ unidad.camion.tipoCamion.nombre }} {{ unidad.semiremolque?.tipo.nombre }} {{unidad.acoplado?.tipo.nombre}}
          </div>
    
          <div class="selector-chofer">
            <label>Asignar Conductor:</label>
            
            <select [(ngModel)]="unidad.transportistaIdUsuario" class="form-select">
              <option [ngValue]="undefined">-- Sin asignar --</option>
               
              <option *ngFor="let chofer of choferesDisponibles" 
                      [ngValue]="chofer.id"
                      [disabled]="choferEstaOcupadoEnOtraUnidad(chofer.id, unidad.UnidadId, viaje)">
                {{ chofer.apellido }}, {{ chofer.nombre }} 
              </option>
            </select>
          </div>
        </div>

        <div class="botones-confirmacion" style="display: flex; gap: 10px; margin-top: 15px;">
          <button (click)="guardarCambios(viaje)" class="btn-guardar" style="background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
            <i class="fa-solid fa-check"></i> Confirmar Asignaciones
          </button>
          
          <button (click)="cancelarAsignacion(viaje)" class="btn-cancelar" style="background-color: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
            Cancelar
          </button>
        </div>

      </div>
    </div>
    </div>
  </div>

  <div *ngIf="viajes.length === 0" class="sin-datos">
    <p style="color:white">¡Todo listo! No hay viajes pendientes.</p>
  </div>
